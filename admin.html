<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="sake_database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2c5282 0%, #8b4513 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; }
        .logout-btn { background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.5); }
        .login-page { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .login-page h2 { margin-bottom: 30px; color: #2c5282; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group button { width: 100%; padding: 12px; background: #2c5282; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .form-group button:hover { background: #1e3a5f; }
        .error { color: #e74c3c; margin-top: 10px; text-align: center; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; color: #2c5282; font-weight: bold; }
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .chart-wrapper { position: relative; height: 400px; }
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f0f0f0; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #2c5282; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <h2>ğŸ¶ ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <div class="form-group">
            <input type="email" id="email" placeholder="ì´ë©”ì¼">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group">
            <button onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
        <div class="error" id="loginError"></div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <h1>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                <button class="logout-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ì´ ì‚¬ìš©ì</h3>
                    <div class="number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ ë…¸íŠ¸</h3>
                    <div class="number" id="totalNotes">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì‚¬ì¼€ ì¢…ë¥˜</h3>
                    <div class="number" id="totalSakes">0</div>
                </div>
            </div>

            <div class="table-container">
                <h3>âš ï¸ ë¯¸ë“±ë¡ ì‚¬ì¼€ (ì§ì ‘ì…ë ¥)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì¼€ ì´ë¦„</th>
                            <th>ì…ë ¥ íšŸìˆ˜</th>
                            <th>ìµœê·¼ ì…ë ¥ì¼</th>
                            <th>ì…ë ¥ ì‚¬ìš©ì ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="unregisteredSakeTable">
                        <tr><td colspan="4">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3>ğŸ“ˆ ì£¼ë³„ ë…¸íŠ¸ ì¶”ê°€</h3>
                <div class="chart-wrapper">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>ğŸ† ì¸ê¸° ì‚¬ì¼€</h3>
                <div class="chart-wrapper">
                    <canvas id="topSakesChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3>ì‚¬ì¼€ë³„ í†µê³„</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì¼€ ì´ë¦„</th>
                            <th>ê¸°ë¡</th>
                            <th>í‰ê· í‰ì </th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>ì ë„</th>
                            <th>í–¥ ê°•ë„</th>
                            <th>í–¥ ë³µí•©ë„</th>
                            <th>í–¥ ì„ ëª…ë„</th>
                            <th>ë§›ì˜ ê°•ë„</th>
                            <th>ë§› ë³µí•©ë„</th>
                            <th>ì‚°ë¯¸</th>
                            <th>ì—¬ìš´</th>
                        </tr>
                    </thead>
                    <tbody id="sakeTable">
                        <tr><td colspan="13">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>ìµœê·¼ ë…¸íŠ¸</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì‚¬ì¼€</th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>í–¥</th>
                            <th>ë§›</th>
                        </tr>
                    </thead>
                    <tbody id="notesTable">
                        <tr><td colspan="7">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://atgfrwohilgucmheyuzu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0Z2Zyd29oaWxndWNtaGV5dXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjAyNTUsImV4cCI6MjA4NTIzNjI1NX0.CoyHTds_3BRl5p6wAehlqaevrdkqp1BzymnTnqhzy2Y';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let charts = {};

        // XSS ë°©ì§€ í•¨ìˆ˜
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (DB ê¸°ë°˜)
        async function checkAdminRole(userId) {
            try {
                const { data, error } = await client
                    .from('admins')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single();

                if (error || !data) return false;
                return true;
            } catch (e) {
                console.error('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', e);
                return false;
            }
        }

        async function adminLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const err = document.getElementById('loginError');

            if (!email || !password) {
                err.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            try {
                const { data, error } = await client.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // DBì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                const isAdmin = await checkAdminRole(data.user.id);
                if (!isAdmin) {
                    await client.auth.signOut();
                    err.textContent = 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }

                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                await loadAllData();

                // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨
                setInterval(loadAllData, 30000);
            } catch (e) {
                err.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message;
            }
        }

        async function adminLogout() {
            await client.auth.signOut();
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginError').textContent = '';
        }

        function buildKnownSakeNames() {
            const known = new Set();
            for (const [brand, info] of Object.entries(SAKE_DATABASE)) {
                for (const product of info.products) {
                    if (product.japanese) {
                        known.add(brand + ' ' + product.name + ' (' + product.japanese + ')');
                    }
                    known.add(brand + ' ' + product.name);
                }
            }
            return known;
        }

        function renderUnregisteredSakes(notes, knownNames) {
            const unregistered = {};
            for (const n of notes) {
                const name = n.sake_name;
                if (!name) continue;
                // Check both the raw name and without the parenthesized part
                const nameWithoutJp = name.replace(/\s*\(.*\)$/, '');
                if (knownNames.has(name) || knownNames.has(nameWithoutJp)) continue;

                if (!unregistered[name]) {
                    unregistered[name] = { count: 0, lastDate: '', users: new Set() };
                }
                unregistered[name].count++;
                if (n.created_at > unregistered[name].lastDate) {
                    unregistered[name].lastDate = n.created_at;
                }
                if (n.user_id) unregistered[name].users.add(n.user_id);
            }

            const sorted = Object.entries(unregistered).sort((a, b) => b[1].count - a[1].count);
            let html = '';
            for (const [name, info] of sorted) {
                const d = new Date(info.lastDate).toLocaleDateString('ko-KR');
                html += `<tr><td>${escapeHtml(name)}</td><td>${info.count}</td><td>${d}</td><td>${info.users.size}</td></tr>`;
            }
            document.getElementById('unregisteredSakeTable').innerHTML = html || '<tr><td colspan="4">ë¯¸ë“±ë¡ ì‚¬ì¼€ ì—†ìŒ</td></tr>';
        }

        async function loadAllData() {
            try {
                const { data: notes, error } = await client.from('tasting_notes').select('*');

                if (error) {
                    console.error('ì¡°íšŒ ì—ëŸ¬:', error);
                    return;
                }

                if (!notes) {
                    console.log('notesê°€ null');
                    return;
                }

                console.log('ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', notes.length);
                console.log('ì²« ë²ˆì§¸ ë…¸íŠ¸:', notes[0]);

                const users = new Set(notes.map(n => n.user_id)).size;
                const sakes = new Set(notes.map(n => n.sake_name)).size;

                document.getElementById('totalUsers').textContent = users;
                document.getElementById('totalNotes').textContent = notes.length;
                document.getElementById('totalSakes').textContent = sakes;

                const knownNames = buildKnownSakeNames();
                renderUnregisteredSakes(notes, knownNames);

                drawCharts(notes);
                drawTables(notes);
            } catch (error) {
                console.error('loadAllData ì—ëŸ¬:', error);
            }
        }

        function drawCharts(notes) {
            // Weekly Chart
            const weekly = {};
            notes.forEach(n => {
                const d = new Date(n.created_at);
                const k = `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7)}`;
                weekly[k] = (weekly[k] || 0) + 1;
            });
            const weeks = Object.keys(weekly).sort().slice(-12);
            if (charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'ë…¸íŠ¸',
                        data: weeks.map(w => weekly[w]),
                        borderColor: '#2c5282',
                        backgroundColor: 'rgba(44, 82, 130, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Top Sakes
            const sakes = {};
            notes.forEach(n => sakes[n.sake_name] = (sakes[n.sake_name] || 0) + 1);
            const top = Object.entries(sakes).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (charts.topSakes) charts.topSakes.destroy();
            charts.topSakes = new Chart(document.getElementById('topSakesChart'), {
                type: 'doughnut',
                data: {
                    labels: top.map(s => escapeHtml(s[0].substring(0, 20))),
                    datasets: [{
                        data: top.map(s => s[1]),
                        backgroundColor: ['#2c5282', '#8b4513', '#e74c3c', '#3498db', '#f39c12', '#27ae60', '#9b59b6', '#1abc9c', '#e67e22', '#34495e']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function drawTables(notes) {
            // Sake Stats
            const stats = {};
            notes.forEach(n => {
                if (!stats[n.sake_name]) stats[n.sake_name] = { 
                    count: 0, 
                    overall_rating_sum: 0,
                    clarity: 0, 
                    transparency: 0,
                    viscosity: 0,
                    aroma_intensity: 0,
                    complexity_aroma: 0,
                    sharpness: 0,
                    flavor: 0,
                    complexity_taste: 0,
                    acidity: 0,
                    aftertaste: 0
                };
                stats[n.sake_name].count++;
                stats[n.sake_name].overall_rating_sum += n.overall_rating || 0;
                stats[n.sake_name].clarity += n.clarity_rating || 0;
                stats[n.sake_name].transparency += n.transparency || 0;
                stats[n.sake_name].viscosity += n.viscosity || 0;
                stats[n.sake_name].aroma_intensity += n.aroma_intensity || 0;
                stats[n.sake_name].complexity_aroma += n.complexity_aroma || 0;
                stats[n.sake_name].sharpness += n.sharpness || 0;
                stats[n.sake_name].flavor += n.flavor || 0;
                stats[n.sake_name].complexity_taste += n.complexity_taste || 0;
                stats[n.sake_name].acidity += n.acidity || 0;
                stats[n.sake_name].aftertaste += n.aftertaste || 0;
            });

            let html = '';
            Object.entries(stats).sort((a, b) => b[1].count - a[1].count).forEach(([sake, s]) => {
                const avgOverall = (s.overall_rating_sum / s.count).toFixed(1);
                html += `<tr>
                    <td>${escapeHtml(sake)}</td>
                    <td>${s.count}</td>
                    <td>${avgOverall}</td>
                    <td>${(s.clarity/s.count).toFixed(1)}</td>
                    <td>${(s.transparency/s.count).toFixed(1)}</td>
                    <td>${(s.viscosity/s.count).toFixed(1)}</td>
                    <td>${(s.aroma_intensity/s.count).toFixed(1)}</td>
                    <td>${(s.complexity_aroma/s.count).toFixed(1)}</td>
                    <td>${(s.sharpness/s.count).toFixed(1)}</td>
                    <td>${(s.flavor/s.count).toFixed(1)}</td>
                    <td>${(s.complexity_taste/s.count).toFixed(1)}</td>
                    <td>${(s.acidity/s.count).toFixed(1)}</td>
                    <td>${(s.aftertaste/s.count).toFixed(1)}</td>
                </tr>`;
            });
            document.getElementById('sakeTable').innerHTML = html || '<tr><td colspan="13">ë°ì´í„° ì—†ìŒ</td></tr>';

            // Recent Notes
            html = '';
            notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 30).forEach(n => {
                const d = new Date(n.created_at).toLocaleDateString('ko-KR');
                const userId = n.user_id ? escapeHtml(n.user_id.substring(0, 8)) : '-';
                const sakeName = escapeHtml(n.sake_name);
                html += `<tr><td>${d}</td><td>${userId}</td><td>${sakeName}</td><td>${n.clarity_rating||'-'}</td><td>${n.transparency||'-'}</td><td>${n.aroma_intensity||'-'}</td><td>${n.flavor||'-'}</td></tr>`;
            });
            document.getElementById('notesTable').innerHTML = html || '<tr><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        window.addEventListener('load', async () => {
            const { data } = await client.auth.getSession();
            if (data.session) {
                // DBì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                const isAdmin = await checkAdminRole(data.session.user.id);
                if (isAdmin) {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    await loadAllData();
                    setInterval(loadAllData, 30000);
                } else {
                    // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì•„ì›ƒ
                    await client.auth.signOut();
                }
            }
        });
    </script>
</body>
</html>
