<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #2c5282 0%, #8b4513 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; }
        .logout-btn { background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.5); }
        .login-page { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .login-page h2 { margin-bottom: 30px; color: #2c5282; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group button { width: 100%; padding: 12px; background: #2c5282; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .form-group button:hover { background: #1e3a5f; }
        .error { color: #e74c3c; margin-top: 10px; text-align: center; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; color: #2c5282; font-weight: bold; }
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .chart-wrapper { position: relative; height: 400px; }
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f0f0f0; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #2c5282; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <h2>ğŸ¶ ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <div class="form-group">
            <input type="email" id="email" placeholder="ì´ë©”ì¼" value="denturebur@naver.com">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group">
            <button onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
        <div class="error" id="loginError"></div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <h1>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                <button class="logout-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ì´ ì‚¬ìš©ì</h3>
                    <div class="number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ ë…¸íŠ¸</h3>
                    <div class="number" id="totalNotes">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì‚¬ì¼€ ì¢…ë¥˜</h3>
                    <div class="number" id="totalSakes">0</div>
                </div>
                <div class="stat-card">
                    <h3>í‰ê·  í‰ì </h3>
                    <div class="number" id="avgRating">0.0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3>ğŸ“ˆ ì£¼ë³„ ë…¸íŠ¸ ì¶”ê°€</h3>
                <div class="chart-wrapper">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>ğŸ† ì¸ê¸° ì‚¬ì¼€</h3>
                <div class="chart-wrapper">
                    <canvas id="topSakesChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3>ì‚¬ì¼€ë³„ í†µê³„</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì¼€ ì´ë¦„</th>
                            <th>ê¸°ë¡</th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>í–¥</th>
                            <th>ë§›</th>
                        </tr>
                    </thead>
                    <tbody id="sakeTable">
                        <tr><td colspan="6">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>ìµœê·¼ ë…¸íŠ¸</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì‚¬ì¼€</th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>í–¥</th>
                            <th>ë§›</th>
                        </tr>
                    </thead>
                    <tbody id="notesTable">
                        <tr><td colspan="7">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://atgfrwohilgucmheyuzu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0Z2Zyd29oaWxndWNtaGV5dXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjAyNTUsImV4cCI6MjA4NTIzNjI1NX0.CoyHTds_3BRl5p6wAehlqaevrdkqp1BzymnTnqhzy2Y';
        const ADMIN_EMAIL = 'denturebur@naver.com';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let charts = {};

        async function adminLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const err = document.getElementById('loginError');

            if (email !== ADMIN_EMAIL) {
                err.textContent = 'ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤.';
                return;
            }

            try {
                const { error } = await client.auth.signInWithPassword({ email, password });
                if (error) throw error;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                await loadAllData();
            } catch (e) {
                err.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message;
            }
        }

        async function adminLogout() {
            await client.auth.signOut();
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginError').textContent = '';
        }

        async function loadAllData() {
            const { data: notes } = await client.from('tasting_notes').select('*');
            if (!notes) return;

            const users = new Set(notes.map(n => n.user_email)).size;
            const sakes = new Set(notes.map(n => n.sake_name)).size;
            let avg = 0;
            if (notes.length > 0) {
                const sum = notes.reduce((s, n) => s + ((n.color_rating||0) + (n.transparency_rating||0) + (n.aroma_rating||0) + (n.taste_rating||0)) / 4, 0);
                avg = (sum / notes.length).toFixed(1);
            }

            document.getElementById('totalUsers').textContent = users;
            document.getElementById('totalNotes').textContent = notes.length;
            document.getElementById('totalSakes').textContent = sakes;
            document.getElementById('avgRating').textContent = avg;

            drawCharts(notes);
            drawTables(notes);
        }

        function drawCharts(notes) {
            // Weekly Chart
            const weekly = {};
            notes.forEach(n => {
                const d = new Date(n.created_at);
                const k = `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7)}`;
                weekly[k] = (weekly[k] || 0) + 1;
            });
            const weeks = Object.keys(weekly).sort().slice(-12);
            if (charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'ë…¸íŠ¸',
                        data: weeks.map(w => weekly[w]),
                        borderColor: '#2c5282',
                        backgroundColor: 'rgba(44, 82, 130, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Top Sakes
            const sakes = {};
            notes.forEach(n => sakes[n.sake_name] = (sakes[n.sake_name] || 0) + 1);
            const top = Object.entries(sakes).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (charts.topSakes) charts.topSakes.destroy();
            charts.topSakes = new Chart(document.getElementById('topSakesChart'), {
                type: 'doughnut',
                data: {
                    labels: top.map(s => s[0].substring(0, 20)),
                    datasets: [{
                        data: top.map(s => s[1]),
                        backgroundColor: ['#2c5282', '#8b4513', '#e74c3c', '#3498db', '#f39c12', '#27ae60', '#9b59b6', '#1abc9c', '#e67e22', '#34495e']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function drawTables(notes) {
            // Sake Stats
            const stats = {};
            notes.forEach(n => {
                if (!stats[n.sake_name]) stats[n.sake_name] = { count: 0, c: 0, t: 0, a: 0, ta: 0 };
                stats[n.sake_name].count++;
                stats[n.sake_name].c += n.color_rating || 0;
                stats[n.sake_name].t += n.transparency_rating || 0;
                stats[n.sake_name].a += n.aroma_rating || 0;
                stats[n.sake_name].ta += n.taste_rating || 0;
            });

            let html = '';
            Object.entries(stats).sort((a, b) => b[1].count - a[1].count).forEach(([sake, s]) => {
                html += `<tr><td>${sake}</td><td>${s.count}</td><td>${(s.c/s.count).toFixed(1)}</td><td>${(s.t/s.count).toFixed(1)}</td><td>${(s.a/s.count).toFixed(1)}</td><td>${(s.ta/s.count).toFixed(1)}</td></tr>`;
            });
            document.getElementById('sakeTable').innerHTML = html || '<tr><td colspan="6">ë°ì´í„° ì—†ìŒ</td></tr>';

            // Recent Notes
            html = '';
            notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 30).forEach(n => {
                const d = new Date(n.created_at).toLocaleDateString('ko-KR');
                html += `<tr><td>${d}</td><td>${n.user_email}</td><td>${n.sake_name}</td><td>${n.color_rating||'-'}</td><td>${n.transparency_rating||'-'}</td><td>${n.aroma_rating||'-'}</td><td>${n.taste_rating||'-'}</td></tr>`;
            });
            document.getElementById('notesTable').innerHTML = html || '<tr><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        window.addEventListener('load', async () => {
            const { data } = await client.auth.getSession();
            if (data.session && data.session.user.email === ADMIN_EMAIL) {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                await loadAllData();
            }
        });
    </script>
</body>
</html>
