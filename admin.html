<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
    <meta name="theme-color" content="#383961">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/svg+xml" href="/icon.svg">
    <link rel="icon" type="image/png" sizes="96x96" href="/icons/icon-96x96.png">
    <link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="sake_database.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; color: #333; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #383961 0%, #DBDFAC 100%); color: white; padding: 30px; border-radius: 12px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 1.8em; }
        .logout-btn { background: rgba(255,255,255,0.3); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .logout-btn:hover { background: rgba(255,255,255,0.5); }
        .login-page { max-width: 400px; margin: 100px auto; background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .login-page h2 { margin-bottom: 30px; color: #383961; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; }
        .form-group button { width: 100%; padding: 12px; background: #383961; color: white; border: none; border-radius: 6px; cursor: pointer; }
        .form-group button:hover { background: #2A2B4A; }
        .error { color: #e74c3c; margin-top: 10px; text-align: center; }
        .dashboard { display: none; }
        .dashboard.active { display: block; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
        .stat-card h3 { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .stat-card .number { font-size: 2.5em; color: #383961; font-weight: bold; }
        .chart-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .chart-wrapper { position: relative; height: 400px; }
        .table-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow-x: auto; margin-bottom: 30px; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #f0f0f0; }
        th { padding: 12px; text-align: left; font-weight: 600; color: #383961; border-bottom: 2px solid #ddd; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background: #eef2ff !important; }
        .register-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center;
            z-index: 10000; padding: 16px;
        }
        .register-modal.active { display: flex; }
        .register-modal-content {
            background: white; border-radius: 12px; width: 100%; max-width: 520px;
            max-height: 90vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.2); padding: 28px 24px;
        }
        .register-modal-header {
            display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;
        }
        .register-modal-header h3 { font-size: 1.3em; font-weight: 700; color: #383961; margin: 0; }
        .register-modal-close {
            width: 36px; height: 36px; border: none; border-radius: 8px;
            background: #f0f0f0; color: #666; font-size: 20px; cursor: pointer;
        }
        .register-modal-close:hover { background: #e0e0e0; }
        .register-field { margin-bottom: 14px; }
        .register-field label { display: block; font-size: 0.85em; font-weight: 600; color: #555; margin-bottom: 4px; }
        .register-field input, .register-field select {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.95em;
        }
        .register-original { margin-bottom: 16px; }
        .register-original label { display: block; font-size: 0.85em; font-weight: 600; color: #999; margin-bottom: 4px; }
        .register-actions { display: flex; gap: 10px; margin-top: 20px; }
        .register-actions button {
            flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; font-weight: 600;
        }
        .register-actions button:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="login-page" id="loginPage">
        <h2>ğŸ¶ ê´€ë¦¬ì ë¡œê·¸ì¸</h2>
        <div class="form-group">
            <input type="email" id="email" placeholder="ì´ë©”ì¼">
        </div>
        <div class="form-group">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸">
        </div>
        <div class="form-group">
            <button onclick="adminLogin()">ë¡œê·¸ì¸</button>
        </div>
        <div class="error" id="loginError"></div>
    </div>

    <div class="dashboard" id="dashboard">
        <div class="container">
            <div class="header">
                <h1>ğŸ“Š ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
                <button class="logout-btn" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>ì „ì²´ íšŒì›</h3>
                    <div class="number" id="totalMembers">0</div>
                </div>
                <div class="stat-card">
                    <h3>ë…¸íŠ¸ ì‘ì„±ì</h3>
                    <div class="number" id="totalUsers">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì´ ë…¸íŠ¸</h3>
                    <div class="number" id="totalNotes">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì‚¬ì¼€ ì¢…ë¥˜</h3>
                    <div class="number" id="totalSakes">0</div>
                </div>
                <div class="stat-card">
                    <h3>ìê²©ì¦ ì†Œì§€ì</h3>
                    <div class="number" id="certifiedUsers" style="color:#10b981;">0</div>
                </div>
                <div class="stat-card">
                    <h3>ì¸ì¦ ëŒ€ê¸°</h3>
                    <div class="number" id="pendingCerts" style="color:#f59e0b;">0</div>
                </div>
            </div>

            <div class="table-container">
                <h3>âš ï¸ ë¯¸ë“±ë¡ ì‚¬ì¼€ (ì§ì ‘ì…ë ¥)</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì¼€ ì´ë¦„</th>
                            <th>ì…ë ¥ íšŸìˆ˜</th>
                            <th>ìµœê·¼ ì…ë ¥ì¼</th>
                            <th>ì…ë ¥ ì‚¬ìš©ì ìˆ˜</th>
                        </tr>
                    </thead>
                    <tbody id="unregisteredSakeTable">
                        <tr><td colspan="4">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>ğŸ… ìê²©ì¦ ì¸ì¦ ìš”ì²­</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ìš©ì</th>
                            <th>ìê²©ì¦ ì¢…ë¥˜</th>
                            <th>ì‹ ì²­ì¼</th>
                            <th>ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody id="certRequestTable">
                        <tr><td colspan="4">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>âœ… ìê²©ì¦ ì†Œì§€ì ëª©ë¡</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì´ë©”ì¼</th>
                            <th>ìê²©ì¦ ì¢…ë¥˜</th>
                            <th>ìŠ¹ì¸ì¼</th>
                        </tr>
                    </thead>
                    <tbody id="certifiedUserTable">
                        <tr><td colspan="3">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="chart-container">
                <h3>ğŸ“ˆ ì£¼ë³„ ë…¸íŠ¸ ì¶”ê°€</h3>
                <div class="chart-wrapper">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h3>ğŸ† ì¸ê¸° ì‚¬ì¼€</h3>
                <div class="chart-wrapper">
                    <canvas id="topSakesChart"></canvas>
                </div>
            </div>

            <div class="table-container">
                <h3>ì‚¬ì¼€ë³„ í†µê³„</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ì‚¬ì¼€ ì´ë¦„</th>
                            <th>ê¸°ë¡</th>
                            <th>í‰ê· í‰ì </th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>ì ë„</th>
                            <th>í–¥ ê°•ë„</th>
                            <th>í–¥ ë³µí•©ë„</th>
                            <th>í–¥ ì„ ëª…ë„</th>
                            <th>ë§›ì˜ ê°•ë„</th>
                            <th>ë§› ë³µí•©ë„</th>
                            <th>ì‚°ë¯¸</th>
                            <th>ì—¬ìš´</th>
                        </tr>
                    </thead>
                    <tbody id="sakeTable">
                        <tr><td colspan="13">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="table-container">
                <h3>ìµœê·¼ ë…¸íŠ¸</h3>
                <table>
                    <thead>
                        <tr>
                            <th>ë‚ ì§œ</th>
                            <th>ì‚¬ìš©ì</th>
                            <th>ì‚¬ì¼€</th>
                            <th>ìƒ‰ê°</th>
                            <th>íˆ¬ëª…ë„</th>
                            <th>í–¥</th>
                            <th>ë§›</th>
                        </tr>
                    </thead>
                    <tbody id="notesTable">
                        <tr><td colspan="7">ë°ì´í„° ë¡œë”© ì¤‘...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ì‚¬ì¼€ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="register-modal" id="registerModal">
        <div class="register-modal-content">
            <div class="register-modal-header">
                <h3>ì‚¬ì¼€ ë“±ë¡</h3>
                <button class="register-modal-close" onclick="closeRegisterModal()">&times;</button>
            </div>
            <div class="register-original">
                <label>ì›ë³¸ ì´ë¦„</label>
                <div id="registerOriginalName" style="padding:8px; background:#f5f5f5; border-radius:6px; font-size:0.95em;"></div>
            </div>
            <div class="register-field">
                <label>ë¸Œëœë“œëª… (í•œê¸€) *</label>
                <input type="text" id="registerBrand" placeholder="ì˜ˆ: ë‹·ì‚¬ì´">
            </div>
            <div class="register-field">
                <label>ë¸Œëœë“œ ì¼ë³¸ì–´</label>
                <input type="text" id="registerBrandJp" placeholder="ì˜ˆ: çºç¥­">
            </div>
            <div class="register-field">
                <label>ì œí’ˆëª… (í•œê¸€) *</label>
                <input type="text" id="registerProductName" placeholder="ì˜ˆ: ì¤€ë§ˆì´ ë‹¤ì´ê¸´ì£  23">
            </div>
            <div class="register-field">
                <label>ì œí’ˆ ì¼ë³¸ì–´</label>
                <input type="text" id="registerJapanese" placeholder="ì˜ˆ: ç´”ç±³å¤§åŸé†¸ ç£¨ãäºŒå‰²ä¸‰åˆ†">
            </div>
            <div class="register-field">
                <label>ë“±ê¸‰</label>
                <select id="registerGrade">
                    <option value="">ì„ íƒ...</option>
                    <option value="ë‹¤ì´ê¸´ì£ ">ë‹¤ì´ê¸´ì£ </option>
                    <option value="ê¸´ì£ ">ê¸´ì£ </option>
                    <option value="ì¤€ë§ˆì´ ë‹¤ì´ê¸´ì£ ">ì¤€ë§ˆì´ ë‹¤ì´ê¸´ì£ </option>
                    <option value="ì¤€ë§ˆì´ ê¸´ì£ ">ì¤€ë§ˆì´ ê¸´ì£ </option>
                    <option value="ì¤€ë§ˆì´">ì¤€ë§ˆì´</option>
                    <option value="í˜¼ì£ ì¡°">í˜¼ì£ ì¡°</option>
                    <option value="ë„ì¿ ë² ì¸  ì¤€ë§ˆì´">ë„ì¿ ë² ì¸  ì¤€ë§ˆì´</option>
                    <option value="ë„ì¿ ë² ì¸  í˜¼ì£ ì¡°">ë„ì¿ ë² ì¸  í˜¼ì£ ì¡°</option>
                    <option value="ë‚˜ë§ˆìì¼€">ë‚˜ë§ˆìì¼€</option>
                    <option value="ë‹ˆê³ ë¦¬">ë‹ˆê³ ë¦¬</option>
                    <option value="í›„ì¸ ìŠˆ">í›„ì¸ ìŠˆ</option>
                </select>
            </div>
            <div class="register-field">
                <label>ì •ë¯¸ë³´í•©</label>
                <input type="text" id="registerPolishRate" placeholder="ì˜ˆ: 45%">
            </div>
            <div class="register-actions">
                <button type="button" onclick="closeRegisterModal()" style="background:#ccc; color:#333;">ì·¨ì†Œ</button>
                <button type="button" onclick="saveCustomSake()" style="background:#383961; color:white;">ë“±ë¡</button>
            </div>
            <div id="registerError" style="color:#e74c3c; text-align:center; margin-top:10px;"></div>
        </div>
    </div>

    <!-- ìê²©ì¦ ì‹¬ì‚¬ ëª¨ë‹¬ -->
    <div class="register-modal" id="certReviewModal">
        <div class="register-modal-content">
            <div class="register-modal-header">
                <h3>ìê²©ì¦ ì‹¬ì‚¬</h3>
                <button class="register-modal-close" onclick="closeCertReviewModal()">&times;</button>
            </div>
            <div class="register-field">
                <label>ì‚¬ìš©ì</label>
                <div id="certReviewUser" style="padding:8px; background:#f5f5f5; border-radius:6px;"></div>
            </div>
            <div class="register-field">
                <label>ìê²©ì¦ ì¢…ë¥˜</label>
                <div id="certReviewType" style="padding:8px; background:#f5f5f5; border-radius:6px;"></div>
            </div>
            <div class="register-field">
                <label>ìê²©ì¦ ì‚¬ì§„</label>
                <div id="certReviewPhoto" style="text-align:center; padding:10px;">
                    <img id="certReviewImg" style="max-width:100%; max-height:400px; border-radius:8px; cursor:pointer;"
                         onclick="window.open(this.src, '_blank')">
                </div>
            </div>
            <div class="register-field" id="certRejectReasonField" style="display:none;">
                <label>ë°˜ë ¤ ì‚¬ìœ </label>
                <input type="text" id="certRejectReason" placeholder="ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="register-actions" id="certReviewActions">
                <button type="button" onclick="rejectCert()" style="background:#e74c3c; color:white;">ë°˜ë ¤</button>
                <button type="button" onclick="approveCert()" style="background:#27ae60; color:white;">ìŠ¹ì¸</button>
            </div>
            <div id="certReviewError" style="color:#e74c3c; text-align:center; margin-top:10px;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://atgfrwohilgucmheyuzu.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF0Z2Zyd29oaWxndWNtaGV5dXp1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjAyNTUsImV4cCI6MjA4NTIzNjI1NX0.CoyHTds_3BRl5p6wAehlqaevrdkqp1BzymnTnqhzy2Y';
        const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        let charts = {};
        let refreshInterval = null;

        // XSS ë°©ì§€ í•¨ìˆ˜
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function escapeAttr(text) {
            if (!text) return '';
            return escapeHtml(text).replace(/'/g, '&#39;');
        }

        // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ (DB ê¸°ë°˜)
        async function checkAdminRole(userId) {
            try {
                const { data, error } = await client
                    .from('admins')
                    .select('user_id')
                    .eq('user_id', userId)
                    .single();

                if (error || !data) return false;
                return true;
            } catch (e) {
                console.error('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', e);
                return false;
            }
        }

        async function adminLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const err = document.getElementById('loginError');

            if (!email || !password) {
                err.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            try {
                const { data, error } = await client.auth.signInWithPassword({ email, password });
                if (error) throw error;

                // DBì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                const isAdmin = await checkAdminRole(data.user.id);
                if (!isAdmin) {
                    await client.auth.signOut();
                    err.textContent = 'ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.';
                    return;
                }

                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                await loadAllData();

                // 30ì´ˆë§ˆë‹¤ ìë™ ìƒˆë¡œê³ ì¹¨ (ì¤‘ë³µ ë°©ì§€)
                if (refreshInterval) clearInterval(refreshInterval);
                refreshInterval = setInterval(loadAllData, 30000);
            } catch (e) {
                err.textContent = 'ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + e.message;
            }
        }

        async function adminLogout() {
            if (refreshInterval) { clearInterval(refreshInterval); refreshInterval = null; }
            await client.auth.signOut();
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginError').textContent = '';
        }

        let customSakesData = [];

        async function loadCustomSakes() {
            const { data, error } = await client.from('custom_sakes').select('*');
            if (!error && data) customSakesData = data;
        }

        function buildKnownSakeNames() {
            const known = new Set();
            for (const [brand, info] of Object.entries(SAKE_DATABASE)) {
                for (const product of info.products) {
                    if (product.japanese) {
                        known.add(brand + ' ' + product.name + ' (' + product.japanese + ')');
                    }
                    known.add(brand + ' ' + product.name);
                }
            }
            // custom_sakesì—ì„œ ë“±ë¡ëœ ê²ƒë„ í¬í•¨
            for (const cs of customSakesData) {
                known.add(cs.original_name);
                if (cs.japanese) {
                    known.add(cs.brand + ' ' + cs.product_name + ' (' + cs.japanese + ')');
                }
                known.add(cs.brand + ' ' + cs.product_name);
            }
            return known;
        }

        function renderUnregisteredSakes(notes, knownNames) {
            const unregistered = {};
            for (const n of notes) {
                const name = n.sake_name;
                if (!name) continue;
                const nameWithoutJp = name.replace(/\s*\(.*\)$/, '');
                if (knownNames.has(name) || knownNames.has(nameWithoutJp)) continue;

                if (!unregistered[name]) {
                    unregistered[name] = { count: 0, lastDate: '', users: new Set() };
                }
                unregistered[name].count++;
                if (n.created_at > unregistered[name].lastDate) {
                    unregistered[name].lastDate = n.created_at;
                }
                if (n.user_id) unregistered[name].users.add(n.user_id);
            }

            const sorted = Object.entries(unregistered).sort((a, b) => b[1].count - a[1].count);
            let html = '';
            for (const [name, info] of sorted) {
                const d = new Date(info.lastDate).toLocaleDateString('ko-KR');
                html += `<tr class="clickable-row" onclick="openRegisterModal('${escapeAttr(name)}')"><td>${escapeHtml(name)}</td><td>${info.count}</td><td>${d}</td><td>${info.users.size}</td></tr>`;
            }
            document.getElementById('unregisteredSakeTable').innerHTML = html || '<tr><td colspan="4">ë¯¸ë“±ë¡ ì‚¬ì¼€ ì—†ìŒ</td></tr>';
        }

        // === ì‚¬ì¼€ ë“±ë¡ ê¸°ëŠ¥ ===
        function detectGrade(name) {
            const gradeMap = [
                { keywords: ['ì¤€ë§ˆì´ ë‹¤ì´ê¸´ì£ ', 'ç´”ç±³å¤§åŸé†¸', 'ì¤€ë§ˆì´ë‹¤ì´ê¸´ì£ '], grade: 'ì¤€ë§ˆì´ ë‹¤ì´ê¸´ì£ ' },
                { keywords: ['ì¤€ë§ˆì´ ê¸´ì£ ', 'ç´”ç±³åŸé†¸', 'ì¤€ë§ˆì´ê¸´ì£ '], grade: 'ì¤€ë§ˆì´ ê¸´ì£ ' },
                { keywords: ['ë„ì¿ ë² ì¸  ì¤€ë§ˆì´', 'ç‰¹åˆ¥ç´”ç±³', 'í† ì¿ ë² ì¸  ì¤€ë§ˆì´'], grade: 'ë„ì¿ ë² ì¸  ì¤€ë§ˆì´' },
                { keywords: ['ë„ì¿ ë² ì¸  í˜¼ì£ ì¡°', 'ç‰¹åˆ¥æœ¬é†¸é€ ', 'í† ì¿ ë² ì¸  í˜¼ì£ ì¡°'], grade: 'ë„ì¿ ë² ì¸  í˜¼ì£ ì¡°' },
                { keywords: ['ë‹¤ì´ê¸´ì£ ', 'å¤§åŸé†¸'], grade: 'ë‹¤ì´ê¸´ì£ ' },
                { keywords: ['ê¸´ì£ ', 'åŸé†¸'], grade: 'ê¸´ì£ ' },
                { keywords: ['ì¤€ë§ˆì´', 'ç´”ç±³'], grade: 'ì¤€ë§ˆì´' },
                { keywords: ['í˜¼ì£ ì¡°', 'æœ¬é†¸é€ '], grade: 'í˜¼ì£ ì¡°' },
                { keywords: ['ë‹ˆê³ ë¦¬', 'ã«ã”ã‚Š'], grade: 'ë‹ˆê³ ë¦¬' },
                { keywords: ['ë‚˜ë§ˆ', 'ç”Ÿé…’', 'ë‚˜ë§ˆìì¼€'], grade: 'ë‚˜ë§ˆìì¼€' },
            ];
            const lower = name.toLowerCase();
            for (const entry of gradeMap) {
                for (const kw of entry.keywords) {
                    if (lower.includes(kw.toLowerCase())) return entry.grade;
                }
            }
            return '';
        }

        function parseSakeName(name) {
            let result = { brand: '', brandJp: '', productName: '', japanese: '', grade: '' };
            if (!name) return result;

            // ê´„í˜¸ ì•ˆ ì¼ë³¸ì–´ ì¶”ì¶œ
            const jpMatch = name.match(/\(([^)]+)\)\s*$/);
            let coreName = name;
            if (jpMatch) {
                result.japanese = jpMatch[1];
                coreName = name.replace(/\s*\([^)]*\)\s*$/, '').trim();
            }

            // ì²« ë²ˆì§¸ í† í° = ë¸Œëœë“œ, ë‚˜ë¨¸ì§€ = ì œí’ˆëª…
            const parts = coreName.split(/\s+/);
            if (parts.length >= 2) {
                result.brand = parts[0];
                result.productName = parts.slice(1).join(' ');
            } else {
                result.brand = coreName;
            }

            result.grade = detectGrade(coreName);
            return result;
        }

        function openRegisterModal(originalName) {
            const parsed = parseSakeName(originalName);
            document.getElementById('registerOriginalName').textContent = originalName;
            document.getElementById('registerOriginalName').dataset.original = originalName;
            document.getElementById('registerBrand').value = parsed.brand;
            document.getElementById('registerBrandJp').value = parsed.brandJp;
            document.getElementById('registerProductName').value = parsed.productName;
            document.getElementById('registerJapanese').value = parsed.japanese;
            document.getElementById('registerGrade').value = parsed.grade;
            document.getElementById('registerPolishRate').value = '';
            document.getElementById('registerError').textContent = '';
            document.getElementById('registerModal').classList.add('active');
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').classList.remove('active');
        }

        async function saveCustomSake() {
            const brand = document.getElementById('registerBrand').value.trim();
            const brandJp = document.getElementById('registerBrandJp').value.trim();
            const productName = document.getElementById('registerProductName').value.trim();
            const japanese = document.getElementById('registerJapanese').value.trim();
            const grade = document.getElementById('registerGrade').value;
            const polishRate = document.getElementById('registerPolishRate').value.trim();
            const originalName = document.getElementById('registerOriginalName').dataset.original;
            const errorEl = document.getElementById('registerError');

            if (!brand || !productName) {
                errorEl.textContent = 'ë¸Œëœë“œëª…ê³¼ ì œí’ˆëª…ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.';
                return;
            }

            try {
                const { data: session } = await client.auth.getSession();
                const userId = session?.session?.user?.id;

                const { error } = await client.from('custom_sakes').insert({
                    brand, brand_jp: brandJp, product_name: productName,
                    japanese, grade, polish_rate: polishRate,
                    original_name: originalName, registered_by: userId
                });

                if (error) {
                    if (error.code === '23505') {
                        errorEl.textContent = 'ì´ë¯¸ ë“±ë¡ëœ ì‚¬ì¼€ì…ë‹ˆë‹¤.';
                    } else {
                        throw error;
                    }
                    return;
                }

                alert('ì‚¬ì¼€ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeRegisterModal();
                await loadAllData();
            } catch (e) {
                errorEl.textContent = 'ë“±ë¡ ì‹¤íŒ¨: ' + e.message;
            }
        }

        async function loadAllData() {
            try {
                await loadCustomSakes();
                const { data: notes, error } = await client.from('tasting_notes').select('*');

                if (error) {
                    console.error('ì¡°íšŒ ì—ëŸ¬:', error);
                    return;
                }

                if (!notes) {
                    console.log('notesê°€ null');
                    return;
                }

                console.log('ì¡°íšŒëœ ë…¸íŠ¸ ìˆ˜:', notes.length);
                console.log('ì²« ë²ˆì§¸ ë…¸íŠ¸:', notes[0]);

                const noteUserIds = new Set(notes.map(n => n.user_id));
                const sakes = new Set(notes.map(n => n.sake_name)).size;

                // ì „ì²´ íšŒì› ìˆ˜: auth.users í…Œì´ë¸”ì—ì„œ ì •í™•í•œ ìˆ˜ ì¡°íšŒ
                const { data: totalCount } = await client.rpc('get_total_users_count');
                document.getElementById('totalMembers').textContent = totalCount || 0;
                document.getElementById('totalUsers').textContent = noteUserIds.size;
                document.getElementById('totalNotes').textContent = notes.length;
                document.getElementById('totalSakes').textContent = sakes;

                const knownNames = buildKnownSakeNames();
                renderUnregisteredSakes(notes, knownNames);

                drawCharts(notes);
                drawTables(notes);
                await loadCertRequests();
            } catch (error) {
                console.error('loadAllData ì—ëŸ¬:', error);
            }
        }

        function drawCharts(notes) {
            // Weekly Chart
            const weekly = {};
            notes.forEach(n => {
                const d = new Date(n.created_at);
                const k = `${d.getFullYear()}-W${Math.ceil((d.getDate() + new Date(d.getFullYear(), d.getMonth(), 1).getDay()) / 7)}`;
                weekly[k] = (weekly[k] || 0) + 1;
            });
            const weeks = Object.keys(weekly).sort().slice(-12);
            if (charts.weekly) charts.weekly.destroy();
            charts.weekly = new Chart(document.getElementById('weeklyChart'), {
                type: 'line',
                data: {
                    labels: weeks,
                    datasets: [{
                        label: 'ë…¸íŠ¸',
                        data: weeks.map(w => weekly[w]),
                        borderColor: '#383961',
                        backgroundColor: 'rgba(44, 82, 130, 0.1)',
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            // Top Sakes
            const sakes = {};
            notes.forEach(n => sakes[n.sake_name] = (sakes[n.sake_name] || 0) + 1);
            const top = Object.entries(sakes).sort((a, b) => b[1] - a[1]).slice(0, 10);
            if (charts.topSakes) charts.topSakes.destroy();
            charts.topSakes = new Chart(document.getElementById('topSakesChart'), {
                type: 'doughnut',
                data: {
                    labels: top.map(s => escapeHtml(s[0].substring(0, 20))),
                    datasets: [{
                        data: top.map(s => s[1]),
                        backgroundColor: ['#383961', '#DBDFAC', '#e74c3c', '#3498db', '#f39c12', '#27ae60', '#9b59b6', '#1abc9c', '#e67e22', '#34495e']
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function drawTables(notes) {
            // Sake Stats
            const stats = {};
            notes.forEach(n => {
                if (!stats[n.sake_name]) stats[n.sake_name] = { 
                    count: 0, 
                    overall_rating_sum: 0,
                    clarity: 0, 
                    transparency: 0,
                    viscosity: 0,
                    aroma_intensity: 0,
                    complexity_aroma: 0,
                    sharpness: 0,
                    flavor: 0,
                    complexity_taste: 0,
                    acidity: 0,
                    aftertaste: 0
                };
                stats[n.sake_name].count++;
                stats[n.sake_name].overall_rating_sum += n.overall_rating || 0;
                stats[n.sake_name].clarity += n.clarity_rating || 0;
                stats[n.sake_name].transparency += n.transparency || 0;
                stats[n.sake_name].viscosity += n.viscosity || 0;
                stats[n.sake_name].aroma_intensity += n.aroma_intensity || 0;
                stats[n.sake_name].complexity_aroma += n.complexity_aroma || 0;
                stats[n.sake_name].sharpness += n.sharpness || 0;
                stats[n.sake_name].flavor += n.flavor || 0;
                stats[n.sake_name].complexity_taste += n.complexity_taste || 0;
                stats[n.sake_name].acidity += n.acidity || 0;
                stats[n.sake_name].aftertaste += n.aftertaste || 0;
            });

            let html = '';
            Object.entries(stats).sort((a, b) => b[1].count - a[1].count).forEach(([sake, s]) => {
                const avgOverall = (s.overall_rating_sum / s.count).toFixed(1);
                html += `<tr>
                    <td>${escapeHtml(sake)}</td>
                    <td>${s.count}</td>
                    <td>${avgOverall}</td>
                    <td>${(s.clarity/s.count).toFixed(1)}</td>
                    <td>${(s.transparency/s.count).toFixed(1)}</td>
                    <td>${(s.viscosity/s.count).toFixed(1)}</td>
                    <td>${(s.aroma_intensity/s.count).toFixed(1)}</td>
                    <td>${(s.complexity_aroma/s.count).toFixed(1)}</td>
                    <td>${(s.sharpness/s.count).toFixed(1)}</td>
                    <td>${(s.flavor/s.count).toFixed(1)}</td>
                    <td>${(s.complexity_taste/s.count).toFixed(1)}</td>
                    <td>${(s.acidity/s.count).toFixed(1)}</td>
                    <td>${(s.aftertaste/s.count).toFixed(1)}</td>
                </tr>`;
            });
            document.getElementById('sakeTable').innerHTML = html || '<tr><td colspan="13">ë°ì´í„° ì—†ìŒ</td></tr>';

            // Recent Notes
            html = '';
            notes.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)).slice(0, 30).forEach(n => {
                const d = new Date(n.created_at).toLocaleDateString('ko-KR');
                const userId = n.user_id ? escapeHtml(n.user_id.substring(0, 8)) : '-';
                const sakeName = escapeHtml(n.sake_name);
                html += `<tr><td>${d}</td><td>${userId}</td><td>${sakeName}</td><td>${n.clarity_rating||'-'}</td><td>${n.transparency||'-'}</td><td>${n.aroma_intensity||'-'}</td><td>${n.flavor||'-'}</td></tr>`;
            });
            document.getElementById('notesTable').innerHTML = html || '<tr><td colspan="7">ë°ì´í„° ì—†ìŒ</td></tr>';
        }

        // === ìê²©ì¦ ì¸ì¦ ì‹¬ì‚¬ ===
        let currentCertReviewId = null;

        async function loadCertRequests() {
            try {
                const { data, error } = await client
                    .from('certifications')
                    .select('id, user_id, user_email, cert_type, status, created_at, reviewed_at, reject_reason')
                    .order('created_at', { ascending: false });
                if (error) throw error;
                renderCertRequests(data || []);
                const pendingCount = (data || []).filter(c => c.status === 'pending').length;
                const pendingEl = document.getElementById('pendingCerts');
                if (pendingEl) pendingEl.textContent = pendingCount;

                // ìê²©ì¦ ì†Œì§€ì (ìŠ¹ì¸ëœ ì¸ì¦)
                const approved = (data || []).filter(c => c.status === 'approved');
                const certifiedCount = new Set(approved.map(c => c.user_id)).size;
                const certifiedEl = document.getElementById('certifiedUsers');
                if (certifiedEl) certifiedEl.textContent = certifiedCount;
                renderCertifiedUsers(approved);
            } catch (e) {
                console.error('Cert requests load error:', e);
            }
        }

        function renderCertifiedUsers(approved) {
            const typeLabels = { kikizakeshi: 'í‚¤í‚¤ìì¼€ì‹œ', sommelier: 'ì‚¬ì¼€ ì†Œë¯ˆë¦¬ì—' };
            let html = '';
            approved.forEach(cert => {
                const email = cert.user_email ? escapeHtml(cert.user_email) : (cert.user_id ? escapeHtml(cert.user_id.substring(0, 8)) + '...' : '-');
                const typeLabel = typeLabels[cert.cert_type] || cert.cert_type;
                const d = cert.reviewed_at ? new Date(cert.reviewed_at).toLocaleDateString('ko-KR') : '-';
                html += `<tr>
                    <td>${email}</td>
                    <td>${escapeHtml(typeLabel)}</td>
                    <td>${d}</td>
                </tr>`;
            });
            document.getElementById('certifiedUserTable').innerHTML = html || '<tr><td colspan="3">ìê²©ì¦ ì†Œì§€ì ì—†ìŒ</td></tr>';
        }

        function renderCertRequests(certs) {
            const typeLabels = { kikizakeshi: 'í‚¤í‚¤ìì¼€ì‹œ', sommelier: 'ì‚¬ì¼€ ì†Œë¯ˆë¦¬ì—' };
            const statusLabels = { pending: 'ëŒ€ê¸°', approved: 'ìŠ¹ì¸', rejected: 'ë°˜ë ¤' };
            const statusColors = { pending: '#f59e0b', approved: '#10b981', rejected: '#ef4444' };

            let html = '';
            certs.forEach(cert => {
                const d = new Date(cert.created_at).toLocaleDateString('ko-KR');
                const userDisplay = cert.user_email ? escapeHtml(cert.user_email) : (cert.user_id ? escapeHtml(cert.user_id.substring(0, 8)) + '...' : '-');
                const typeLabel = typeLabels[cert.cert_type] || cert.cert_type;
                const statusLabel = statusLabels[cert.status] || cert.status;
                const statusColor = statusColors[cert.status] || '#666';
                html += `<tr class="clickable-row" onclick="openCertReview('${cert.id}')">
                    <td>${userDisplay}</td>
                    <td>${escapeHtml(typeLabel)}</td>
                    <td>${d}</td>
                    <td><span style="color:${statusColor}; font-weight:600;">${escapeHtml(statusLabel)}</span></td>
                </tr>`;
            });
            document.getElementById('certRequestTable').innerHTML = html || '<tr><td colspan="4">ì¸ì¦ ìš”ì²­ ì—†ìŒ</td></tr>';
        }

        async function openCertReview(certId) {
            currentCertReviewId = certId;
            try {
                const { data: cert, error } = await client
                    .from('certifications')
                    .select('*')
                    .eq('id', certId)
                    .single();
                if (error || !cert) {
                    alert('ì¸ì¦ ìš”ì²­ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                document.getElementById('certReviewUser').textContent = cert.user_email || cert.user_id.substring(0, 12) + '...';
                document.getElementById('certReviewType').textContent =
                    cert.cert_type === 'kikizakeshi' ? 'í‚¤í‚¤ìì¼€ì‹œ (åˆ©é…’å¸«)' : 'ì‚¬ì¼€ ì†Œë¯ˆë¦¬ì—';

                const img = document.getElementById('certReviewImg');
                if (cert.cert_photo) {
                    img.src = cert.cert_photo;
                    img.style.display = 'block';
                } else {
                    img.style.display = 'none';
                }

                const rejectField = document.getElementById('certRejectReasonField');
                const actions = document.getElementById('certReviewActions');
                if (cert.status === 'pending') {
                    rejectField.style.display = 'none';
                    actions.style.display = 'flex';
                } else {
                    rejectField.style.display = 'none';
                    actions.style.display = 'none';
                }

                document.getElementById('certReviewError').textContent = '';
                document.getElementById('certRejectReason').value = '';
                document.getElementById('certReviewModal').classList.add('active');
            } catch (e) {
                alert('ì˜¤ë¥˜: ' + e.message);
            }
        }

        function closeCertReviewModal() {
            document.getElementById('certReviewModal').classList.remove('active');
            currentCertReviewId = null;
        }

        async function approveCert() {
            if (!currentCertReviewId) return;
            try {
                const { data: session } = await client.auth.getSession();
                const reviewerId = session?.session?.user?.id;
                const { error } = await client
                    .from('certifications')
                    .update({
                        status: 'approved',
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: reviewerId
                    })
                    .eq('id', currentCertReviewId);
                if (error) throw error;
                alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeCertReviewModal();
                await loadCertRequests();
            } catch (e) {
                document.getElementById('certReviewError').textContent = 'ìŠ¹ì¸ ì‹¤íŒ¨: ' + e.message;
            }
        }

        async function rejectCert() {
            if (!currentCertReviewId) return;
            const rejectField = document.getElementById('certRejectReasonField');
            if (rejectField.style.display === 'none') {
                rejectField.style.display = 'block';
                document.getElementById('certRejectReason').focus();
                return;
            }
            const reason = document.getElementById('certRejectReason').value.trim();
            try {
                const { data: session } = await client.auth.getSession();
                const reviewerId = session?.session?.user?.id;
                const { error } = await client
                    .from('certifications')
                    .update({
                        status: 'rejected',
                        reject_reason: reason || null,
                        reviewed_at: new Date().toISOString(),
                        reviewed_by: reviewerId
                    })
                    .eq('id', currentCertReviewId);
                if (error) throw error;
                alert('ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeCertReviewModal();
                await loadCertRequests();
            } catch (e) {
                document.getElementById('certReviewError').textContent = 'ë°˜ë ¤ ì‹¤íŒ¨: ' + e.message;
            }
        }

        window.addEventListener('load', async () => {
            const { data } = await client.auth.getSession();
            if (data.session) {
                // DBì—ì„œ ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                const isAdmin = await checkAdminRole(data.session.user.id);
                if (isAdmin) {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    await loadAllData();
                    if (refreshInterval) clearInterval(refreshInterval);
                    refreshInterval = setInterval(loadAllData, 30000);
                } else {
                    // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë¡œê·¸ì•„ì›ƒ
                    await client.auth.signOut();
                }
            }
        });
    </script>
</body>
</html>
